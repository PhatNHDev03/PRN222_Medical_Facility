@page
@model MedicaiFacility.RazorPage.Pages.MedicalHistories.MyMedicalHistoryModel
@{
}@if (TempData["SuccessMessage"] != null)
{
	<div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<table class="table table-bordered">
	<thead class="thead-dark">
		<tr>
			<th>History ID</th>
			<th>Description</th>
			<th>History Status</th>
			<th>Created At</th>
			<th>Updated At</th>
			<th>Start Date</th>
			<th>End Date</th>
			<th>Appointment Status</th>
			<th>Patient Info</th>
			<th>Expert Info</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		@foreach (var history in Model.MedicalHistoryViewModels)
		{
			<tr>
				<td>@history.HistoryId</td>
				<td>@(history.Description ?? "No Description")</td>
				<td>@(history.Status ?? "Unknown")</td>
				<td>@(history.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</td>
				<td>@(history.UpdatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</td>
				<td>@history.StartDate.ToString("yyyy-MM-dd HH:mm")</td>
				<td>@(history.EndDate?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</td>
				<td>@(history.AppointmentStatus ?? "N/A")</td>
				<td>@(history.patientInfor ?? "Unknown")</td>
				<td>@(history.ExpertInfor ?? "Unknown")</td>
				<td>
					<button class="btn btn-primary" onclick="window.location.href='@Url.Page("/MedicalHistories/Detail", new { id = history.HistoryId })'"> History Detail</button>
					@if (history.Status == "Completed")
					{
						<button class="btn btn-dark" onclick="window.location.href='@Url.Page("/HealthRecords/Detail", new { id = history.HistoryId })'">Health record Detail</button>

					}

					@if (User.FindFirstValue(ClaimTypes.Role) == "MedicalExpert")
					{
						if (history.Status != "Cancel" && history.Status != "Completed" && history.Status != "Incomplete")
						{
							<button class="btn btn-warning btn-sm" onclick="openModal( @history.HistoryId)">Edit</button>
						}
						if (history.Status == "Completed")
						{
							<button class="btn btn-danger" onclick="window.location.href='@Url.Page("/HealthRecords/Edit", new { id = history.HistoryId })'">Health record Edit</button>
						}

					}

				</td>
			</tr>
		}
	</tbody>
</table>


<!-- Modal Confirm -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title" id="deleteModalLabel">Update history</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="modalForm">
				<p>Loading...</p> <!-- Sẽ được thay thế bằng nội dung form -->
			</div>

		</div>
	</div>
</div>



<script>
	async function openModal(id = null) {
		let url = `/MedicalHistories/Edit?id=${id}`;

		try {
			let response = await fetch(url);
			let data = await response.text();

			let modalForm = document.getElementById("modalForm");
			modalForm.innerHTML = data;
			let modal = new bootstrap.Modal(document.getElementById("confirmModal"));
			modal.show();

		} catch (error) {
			console.error("Error loading modal:", error);
		}
	}

	function closeModal() {
		let modalElement = document.getElementById("confirmModal");
		let modal = bootstrap.Modal.getInstance(modalElement);
		if (modal) {
			modal.hide();
		}
		document.getElementById("modalForm").innerHTML = "";
	}


</script>

@if (Model.Pager.TotalPages > 0)
{
	<ul class="pagination justify-content-end">
		@if (Model.Pager.CurrentPage > 1)
		{
			<li class="page-item">
				<a class="page-link" asp-page="/MedicalHistories/MyMedicalHistory" asp-route-pg="@(Model.Pager.StartPage)">First</a>
			</li>
			<li class="page-item">
				<a class="page-link" asp-page="/MedicalHistories/MyMedicalHistory" asp-route-pg="@(Model.Pager.CurrentPage-1)">Previous</a>
			</li>
		}
		@for (var pge = Model.Pager.StartPage; pge <= Model.Pager.EndPage; pge++)
		{
			<li class="page-item @(pge == Model.Pager.CurrentPage ? "active" : "")">
				<a class="page-link" asp-page="/MedicalHistories/MyMedicalHistory" asp-route-pg="@pge">@pge</a>
			</li>
		}
		@if (Model.Pager.CurrentPage < Model.Pager.TotalPages)
		{
			<li class="page-item">
				<a class="page-link" asp-page="/MedicalHistories/MyMedicalHistory" asp-route-pg="@(Model.Pager.CurrentPage+1)">Next</a>
			</li>
			<li class="page-item">
				<a class="page-link" asp-page="/MedicalHistories/MyMedicalHistory" asp-route-pg="@(Model.Pager.TotalPages)">Last</a>
			</li>
		}
	</ul>
}


<style>
	/* Căn chỉnh bảng */
	.table {
		margin-top: 20px;
		text-align: center;
		vertical-align: middle;
	}

		/* Tăng khoảng cách giữa các dòng */
		.table tbody tr {
			height: 50px;
		}

		/* Căn chỉnh các tiêu đề cột */
		.table thead th {
			background-color: #343a40 !important;
			color: white !important;
			text-align: center;
		}

	/* Định dạng cho các nút hành động */
	.btn {
		margin: 2px;
	}

	/* Modal */
	.modal-header {
		border-bottom: none;
	}

	.modal-body {
		text-align: center;
	}

	/* Định dạng cho pagination */
	.pagination {
		margin-top: 20px;
	}

	.page-item.active .page-link {
		background-color: #007bff;
		border-color: #007bff;
	}

	.page-link {
		color: #007bff;
	}

		.page-link:hover {
			background-color: #e9ecef;
		}

</style>